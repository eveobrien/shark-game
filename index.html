<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Flappy Shark</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      background: #1a1429;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    canvas {
      border: 4px solid #6f4fa3;
      image-rendering: pixelated;
      cursor: pointer;
    }
  </style>
</head>
<body>

<canvas id="game" width="400" height="600"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
ctx.imageSmoothingEnabled = false;

// === COLORS ===
const COLORS = {
  purple: "#9b7bd3",
  purpleDark: "#6f4fa3",
  yellow: "#f2d16b",
  bg: "#1a1429"
};

// === GAME STATE ===
let gameState = "start";
let frame = 0;
let score = 0;
let freezeTimer = 0;
let transitionY = 0;

// === PHYSICS ===
const gravity = 0.5;
const jumpStrength = -7;
const pipeGap = 110;
const pipeWidth = 40;
const pipeSpeed = 2;

// === SHARK ===
const shark = { x: 80, y: 300, v: 0 };

// === GHOST ===
let ghostPath = JSON.parse(localStorage.getItem("ghostPath")) || [];
let currentRun = [];
let bestScore = Number(localStorage.getItem("bestScore")) || 0;

// === INPUT ===
document.addEventListener("keydown", e => {
  if (e.code === "Space" && gameState === "playing") {
    shark.v = jumpStrength;
  }

  if (e.code === "Space" && gameState === "start") {
    reset();
  }

  // DEV CHEAT ‚Äî REMOVE BEFORE SENDING üíú
  if (e.code === "KeyV") {
    gameState = "freeze";
  }
});

// === CLICK (VALENTINE BUTTONS) ===
canvas.addEventListener("click", () => {
  if (gameState === "valentine") {
    gameState = "accepted";
  }
});

// === RESET ===
function reset() {
  shark.y = 300;
  shark.v = 0;
  pipes = [];
  frame = 0;
  score = 0;
  currentRun = [];
  transitionY = 0;
  gameState = "playing";
}

// === PIPES ===
let pipes = [];
function spawnPipe() {
  const top = Math.random() * 250 + 50;
  pipes.push({ x: canvas.width, top });
}

// === UPDATE ===
function update() {
  frame++;

  if (gameState === "playing") {
    shark.v += gravity;
    shark.y += shark.v;
    currentRun.push(shark.y);

    if (frame % 120 === 0) spawnPipe();

    pipes.forEach(p => p.x -= pipeSpeed);
    pipes = pipes.filter(p => p.x + pipeWidth > 0);

    pipes.forEach(p => {
      if (
        shark.x < p.x + pipeWidth &&
        shark.x + 16 > p.x &&
        (shark.y < p.top || shark.y > p.top + pipeGap)
      ) endGame();
    });
  }

  if (gameState === "freeze") {
    freezeTimer++;
    if (freezeTimer > 60) gameState = "transition";
  }

  if (gameState === "transition") {
    transitionY += 6;
    if (transitionY >= canvas.height) gameState = "valentine";
  }
}

// === END GAME ===
function endGame() {
  if (score > bestScore) {
    bestScore = score;
    ghostPath = currentRun;
    localStorage.setItem("ghostPath", JSON.stringify(ghostPath));
    localStorage.setItem("bestScore", bestScore);
  }
  freezeTimer = 0;
  gameState = "freeze";
}

// === DRAW ===
function drawShark() {
  ctx.fillStyle = COLORS.purple;
  ctx.fillRect(shark.x, shark.y, 16, 8);
  ctx.fillRect(shark.x + 4, shark.y - 4, 8, 4);
}

function drawPipes() {
  ctx.fillStyle = "#7a2b3a";
  pipes.forEach(p => {
    ctx.fillRect(p.x, 0, pipeWidth, p.top);
    ctx.fillRect(p.x, p.top + pipeGap, pipeWidth, canvas.height);
  });
}

function drawHeart(x, y, pulse) {
  ctx.fillStyle = COLORS.yellow;
  const s = pulse ? 6 : 5;
  ctx.fillRect(x, y, s, s);
  ctx.fillRect(x + s + 2, y, s, s);
  ctx.fillRect(x + 2, y + s, s + 2, s);
}

function drawValentineScreen() {
  ctx.fillStyle = COLORS.bg;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  const pulse = Math.sin(frame * 0.1) > 0;
  drawHeart(190, 150, pulse);

  ctx.font = "12px 'Press Start 2P'";
  ctx.fillStyle = COLORS.purple;
  ctx.fillText("WILL YOU BE MY", 200, 240);
  ctx.fillStyle = COLORS.yellow;
  ctx.fillText("VALENTINE?", 200, 270);

  ctx.fillStyle = COLORS.purpleDark;
  ctx.fillRect(120, 330, 70, 30);
  ctx.fillRect(210, 330, 70, 30);

  ctx.fillStyle = "#fff";
  ctx.font = "8px 'Press Start 2P'";
  ctx.fillText("YES", 155, 350);
  ctx.fillText("YES", 245, 350);
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (gameState !== "valentine" && gameState !== "accepted") {
    ctx.save();
    ctx.translate(0, -transitionY);
    drawPipes();
    drawShark();
    ctx.restore();
  }

  if (gameState === "valentine") drawValentineScreen();

  if (gameState === "accepted") {
    ctx.fillStyle = COLORS.bg;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = COLORS.yellow;
    ctx.font = "12px 'Press Start 2P'";
    ctx.fillText("‚ù§Ô∏è SHE SAID YES ‚ù§Ô∏è", 200, 300);
  }
}

// === LOOP ===
function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
